<!DOCTYPE html>
<html>
<head>
    <title>Coral Database</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css">
    <style>
        h1 {
            text-align: center;
            font-size: 30px;
        }
        table {
            border-collapse: collapse;
            width: auto;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #AEC5F4;
        }
        .user-input {
            border: 1px solid ;
            padding: 10px;
            margin-bottom: 20px;
        }
        .slidecontainer {
            width: 50%;
        }
        .example-text {
            margin-left: 10px;
        }
        .tabbar {
            display: flex;
            width: auto;
            justify-content: space-between;
            background-color: #f1f1f1;
            padding: 10px;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }
        .tab {
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
        }
        .tab.active {
            background-color: #ccc;
            box-shadow: none;
        }
        .tabcontent {
            display: none;
        }
        .active-tabcontent {
            display: block;
        }
        .collapsible {
            background-color: #777;
            color: white;
            cursor: pointer;
            padding: 12px;
            width: auto;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            display: flex;
            align-items: center;
        }
        .collapsible.active, .collapsible:hover {
            background-color: #555;
        }
        .collapsible::before {
            content: "\25BA";
            margin-right: 10px;
        }
        .active.collapsible::before {
            content: "\25BC";
        }
        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }
        .submit_button {
            height:40px;
            width:75px;
            border-radius: 25px;
        }
        .hover-value {
            font-size: 15px;
            margin-top: 5px;
        }
        .noUi-value {
            color: black; 
            font-size: 15px;
        }
		
    </style>
</head>
<body>

    <h1><strong>Porites (Stony Coral) Database</strong></h1>
    
    <!-- --------------
        WEBSITE TABS 
    ---------------- -->
    <div class="tabbar">
        <div class="tab" onclick="openTab(event, 'intro')">Home</div>
        <div class="tab" onclick="openTab(event, 'data')">Data</div>
        <div class="tab" onclick="openTab(event, 'media')">Media</div>
        <div class="tab" onclick="openTab(event, 'help')">Help</div>
    </div>

    <!-- ------------------
        INTRODUCTION TAB
    -------------------- -->
    <div id="intro" class="tabcontent active-tabcontent"><br>
        <div class="user-input">
			<p><strong>Project Name: </strong>A Comprehensive Database for Coral Diversity in Turneffe Atoll</p>
			<p><strong>Student Developers: </strong>Johnathan Zhang, Saumya Pothukuchi, Zachary Derse, Grace Aboussleman</p>
			<p><strong>Faculty Advisor: </strong> Dr. John Finnerty, Department of Biology Department & BU Marine Program
			<p><strong>Statement: </strong> This project was developed at Boston University as part of BF768, Spring 2024, under Prof. Gary Benson as the instructor.</p>
            <p><strong>Abstract: </strong>For the past decade, the Finnerty lab has collected multiple data types surrounding coral reef populations in Turneffe Atoll Marine Reserve, Belize, for the coral species Finger Coral (Porites porites). 
			The data is divided into two main categories: phenotypic and variant call data (vcf data). The phenotypic data is further divided into location information, ecological volume (area covered by a coral colony),
			Tag IDs, which are the IDs by which the coral can be recognised, etc.</p> 
        </div>
    </div

    <!-- ---------------------
        DATABASE SEARCH TAB
    ----------------------- -->
    <div id="data" class="tabcontent">
        <p style="font-size:18px;">This tab allows the user to explore the coral phenotypic and vcf data. The data can also be filtered by the options present in the filters section.</p>
        <div class="user-input">
            <!-- All Filters -->
            <div class="collapsible">Filters</div>
            <div class="content">
                <br>
                Input Tag ID: <input type="text" name="tagid">
                <span class="example-text">(Example Tag IDs: )</span>
                <p style="font-size:17px;text-align: left;"><strong>OR</strong></p>
                Input Scaffold: <input type="text" name="scaffold">
                <span class="example-text">(Example Scaffolds: )</span> <br><br>

                <!-- Phenotypic Data Filters -->
                <div class="collapsible">Phenotypic Data Filters</div>
                <div class="content"><br>
                    <div class="slidecontainer">
                        <!-- QUESTIONS ABOUT ECO VOLUME ????????????????????????????????????
                        should probably only include ln eco volume for convenience
                        Is the slider supposed to be greater than/less than???????????????????-->
                        Ecological Volume (units):<div id="eco_vol_value" class="hover-value"></div><br>
                        <div id="eco_vol"></div>
                        <br><br><br>

                        Natural Log of Ecological Volume (units):<div id="ln_eco_vol_value" class="hover-value"></div><br>
                        <div id="ln_eco_vol"></div>
                        <br><br><br>

                        Location: <input type="checkbox" name="location" value="Channel-North"> Channel-North
                        <input type="checkbox" name="location" value="Channel-South"> Channel-North
                        <input type="checkbox" name="location" value="Creek-West"> Creek-West
                        <input type="checkbox" name="location" value="Creek-East"> Creek-East<br><br>

                        Year: <input type="checkbox" name="year" value="2015"> 2015
                        <input type="checkbox" name="year" value="2016"> 2016
                        <input type="checkbox" name="year" value="2017"> 2017
                        <input type="checkbox" name="year" value="2018"> 2018<br><br>

                        Mortality: <input type="checkbox" name="mortality" value="Alive"> Alive
                        <input type="checkbox" name="mortality" value="Missing"> Missing
                        <input type="checkbox" name="mortality" value="Dead"> Dead<br><br>
                    </div>
                </div>

                <!-- VCF Data Filters -->
                <div class="collapsible">VCF Filters</div>
                <div class="content"><br>
                    <div class="slidecontainer">
                        Allele Frequency:<div id="allele_freq_value" class="hover-value"></div><br>
                        <div id="allele_freq"></div><br><br><br>
                    </div>
                </div>
                <br>

                <!-- ?????????????? WE SHOULD ADD ANOTHER DROPDOWN FOR ADVANCED FILTERS
                LIKE GROUP BY, COUNT, AGGREGATE FUNCTIONS...-->
                <button class = "submit_button" id="submit_button" type="button">Submit</button><br><br>
                <button class= "submit_button" id="csv_button" type="button">Download csv</button><br><br>
            </div>
        </div>
    </div>
	
    <!-- Output data table -->     <!-- DOES THIS GO HERE???????????????????-->
    <div id="out_table"></div>
    <div id="store_results"></div>         <!-- Random div to store results of query (for download button?)-->
    

    <!-- ----------- 
        MEDIA TAB
    ------------- -->
    <div id="media" class="tabcontent"><br>
        <div class="user-input">
            Link to coral pics
        </div>
    </div>

    <!-- ---------
        HELP TAB
    ----------- -->
    <div id="help" class="tabcontent"><br>
        <div class="user-input">
            <p style="font-size:17px;"><strong>The steps below can be used as a guide to navigate the site:</strong></p>
			<ol>
				<li>Input Tag ID</li>
			</ol>	
			<br>
			<p style="font-size:17px;"><strong>Further information on each tab/filter which can be found below:</strong></p>
            <ol>
				<br>
                    <button class="collapsible">Input Tag ID/ Scaffold ID</button>
					<div class="content">
					 <ul>
						<li>
							<p>A straightforward way to retrieve information on a particular coral is to input a Tag ID or Scaffold ID of interest.
							</p>
						</li>
						<li>
							<p>If there are other filters which need to be applied to then they can be selected from the Phenotypic Data Filter tab or the VCF Filter tab. 
								(See below for further details on those sections)
							</p>
						</li>	
					</ul>
					</div>
                <br>
                    <button class="collapsible">Phenotypic Data Filters</button>
					<div class="content">
					<ul>
						<li>
							<p>Ecological Volume:</p> 
							<ul>
								<li>Refers to the volume which is occupied by the coral colony. </li>
								<li>Slider can be used to pick a cutoff value (i.e, all corals with volume <strong>LESS THAN</strong> the selected value will be returned). It should be left at default 0 if all values are of interest.</li>
								<li>The sliders number is updated dynamically above the slider and can be used to pick cutoff values with increased sensitivity.</li>
							</ul>
						</li>
						<li>
							<p>Natural Log of Ecological Volume:</p>
							<ul>
								<li>Natural log of ecological volume.</li>
								<li>Slider can be used to pick a cutoff value (i.e, all corals with volume <strong>LESS THAN</strong> the selected value will be returned). It should be left at default 0 if all values are of interest.</li>
								<li>The sliders number is updated dynamically above the slider and can be used to pick cutoff values with increased sensitivity.</li>
							</ul>
						</li>
						<li>
							<p>Location:</p>
							<ul>
								<li>There are 4 locations from where coral data was collected from: Channel-North, Channel-South, Creek-West and Creek-East.</li>
								<li>There are checkboxes present to select the locations of interest, and multiple locations can be selected if desired.</li>
								<li>The locations selected are the <strong>ONLY</strong> ones which will be returned. It should be left blank if all values are of interest.</li>
							</ul>
						</li>
						<li>
							<p>Year:</p>
							<ul>
								<li>Similar to location, the year filter allows the user to filter data based on the year of interest. Data was collected over 4 years: 2015, 2016, 2017 and 2018.</li>
								<li>Checkboxes are present to select the years of interest, and multiple years can be selected if desired.</li>
								<li>The years selected are the ONLY ones which will be returned. </li>
								<li><strong>Year CANNOT BE BLANK due to the nature of the dataset and the default year is 2015.</strong></li>
							</ul>
						</li>
						<li>
							<p>Mortality:</p>
							<ul>
								<li>Similar to other checkbox filters, the mortality filter allows the user to filter data based whether the coral of interest on Alive/Dead/Missing.</li>
								<li>There are many corals which correspond to dead <strong>OR</strong> missing since determining the cause of disappearance is difficult. 
								The corals with both values will be returned irrespective of whether dead is chosen or missing.It should be left blank if all values are of interest.</li>
								<li>This filter is particularly useful in combination with the year filter to study the survivalship of the corals of interest.</li>
							</ul>
						</li>						
					</ul>
					</div>
				<br>
				<button class="collapsible"> VCF Filters</button>
					<div class="content">
					<ul>
						<li>
							<p>Allele Frequency:</p> 
							<ul>
								<li>Allele frequency refers to the relative frequency of the variant at a particular locus. 
								This is an important metric since it can be used to study the fraction of all chromosomes in the population 
								that carry that allele over the sample size, espeically if it can potentially make corals resilient for better survivalship.</li>
								<li>Slider can be used to pick a cutoff value (i.e, all corals with allele frequency <strong>LESS THAN</strong> the selected value will be returned). It should be left at default 0 if all variants are of interest.</li>
								<li>The sliders number is updated dynamically above the slider and can be used to pick cutoff values with increased sensitivity.</li>
							</ul>
						</li>
					</ul>
					</div>	
            </ol>
        </div>
    </div>

    <!-- ------------------------
        JAVASCRIPT/JQUERY/AJAX
    --------------------------- -->
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Main -->
    <script>
        //////////////////////////
        //  JAVASCRIPT FOR UI   //
        //////////////////////////

        // JavaScript for tabs functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        // Collapsible section functionality
        var coll = document.getElementsByClassName("collapsible");
        var i;

        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                console.log("Clicked!");
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        }
		
		// Sliders
        var ecoVolSlider = document.getElementById('eco_vol');
		var ecoVol_field = document.getElementById('eco_vol_value');
        var lnEcoVolSlider = document.getElementById('ln_eco_vol');
		var lnVol_field = document.getElementById('ln_eco_vol_value');
        var alleleFreqSlider = document.getElementById('allele_freq');
		var allele_field = document.getElementById('allele_freq_value');

        noUiSlider.create(ecoVolSlider, {
            start: [0],
			behaviour: 'hover-snap',
            range: {
                'min': 0,
                'max': 35000
            },
            pips: {
                mode: 'values',
                values: [0, 10000, 20000, 30000, 35000],
                density: 4
            }
        });
		ecoVolSlider.noUiSlider.on('update', function (values, handle) {
			ecoVol_field.innerHTML = values[handle];
		});
		
        noUiSlider.create(lnEcoVolSlider, {
            start: [0],
			behaviour: 'hover-snap',
            range: {
                'min': -4,
                'max': 12
            },
            pips: {
                mode: 'values',
                values: [-4, 0, 4, 8, 12],
                density: 4
            }
        });
		lnEcoVolSlider.noUiSlider.on('update', function (values, handle) {
			lnVol_field.innerHTML = values[handle];
		});

        noUiSlider.create(alleleFreqSlider, {
            start: [0],
			behaviour: 'hover-snap',
            range: {
                'min': 0,
                'max': 1
            },
            pips: {
                mode: 'values',
                values: [0, 0.25, 0.5, 0.75, 1],
                density: 4
            }
        });
		alleleFreqSlider.noUiSlider.on('update', function (values, handle) {
			allele_field.innerHTML = values[handle];
		});

		////////////////////
        // Document Load  //
        ////////////////////
        
        // ???????????????? We want a table to be loaded when the webpage is loaded right ?????????????????????
        // We should do that in the document.ready
        $(document).ready(function() {
            // Ajax call to populate table first with 2015 data
            $.get("https://bioed.bu.edu/cgi-bin/students_24/saumyapo/coral_cgi.py",
                {'selector':'default_query'},
                function(data){
                    create_table(data)},
                "json");
        })

        ////////////////////
        // AAAAJJJAAAXXXX //
        ////////////////////
        $("#submit_button").click(function(){
            // Empty data table
            $("#out_table").empty();
            
            // Retrieve filters              ???????????? for checkboxes do i retrieve 'eco_vol_value' or just 'eco_vol'?????????????????
            let tagid = $("#tagid").val();
            let scaffoldid = $("#scaffold").val();
            let location = $("#location").val();
            let mortality = $("#mortality").val();
            let year = $("#year").val();
            let eco_vol = $("#eco_vol_value").val();
            let ln_eco_vol = $("#ln_eco_vol_value").val();
            let allele_freq = $("#allele_freq_value").val();

            // AJAX call
            $.get("https://bioed.bu.edu/cgi-bin/students_24/saumyapo/coral_cgi.py",
                {'tagid':tagid,
                    'scaffoldid':scaffoldid,
                    'location':location,
                    'mortality':mortality,
                    'year':year,
                    'eco':eco_vol,
                    'ln_eco_vol':ln_eco_vol,
                    'allele_freq':allele_freq},
                function(data){
                    create_table(data)},
                "json");
        })

        //////////////////////////////////////
        // Create table from returned query //
        //////////////////////////////////////
        function create_table(json) {
            // Initialize variable to store HTML table
            let table_body_contents = "";

            // ????????????????? STORE QUERY RESULTS FOR DOWNLOAD ????????????????????
            // Is this the best way to implement this? <div id="store_results">...</div>
            $("#store_results").append(json);
            
            // ???????????? NEEDS MAJOR WORK?????????????????
            // When am I supposed to include VCF column?
            for (let row= 0; row<json.length; row++) {

                tagid = json[row][0];
                location = json[row][1];
                notes = json[row][2];
                alive_status = json[row][3];
                length_cm = json[row][4];
                width_cm = json[row][5];
                height_cm = json[row][6];
                lw_div_4 = json[row][7];
                lw_div_4_sq = json[row][8];
                eco_volume = json[row][9];
                ln_eco_volume = json[row][10];
                volume_cylinder = json[row][11];
                tip_number = json[row][12];
                old_tag = json[row][13];
                
                table_body_contents +=  `<tr>
                                            <td>${tagid}</td>
                                            <td>${location}</td>
                                            <td>${notes}</td>
                                            <td>${alive_status}</td>
                                            <td>${length_cm}</td>
                                            <td>${width_cm}</td>
                                            <td>${height_cm}</td>
                                            <td>${lw_div_4}</td>
                                            <td>${lw_div_4_sq}</td>
                                            <td>${eco_volume}</td>
                                            <td>${ln_eco_volume}</td>
                                            <td>${volume_cylinder}</td>
                                            <td>${tip_number}</td>
                                            <td>${old_tag}</td>
                                        </tr>`;
            }

                var table_template = `  <table>
                                            <thead>
                                                <tr>
                                                    <th>Tag ID</th>
                                                    <th>Location</th>
                                                    <th>Notes</th>
                                                    <th>Alive Status</th>
                                                    <th>Length (cm)</th>
                                                    <th>Width (cm)</th>
                                                    <th>Height (cm)</th>
                                                    <th>(Length + Width)/4</th>
                                                    <th>((Length + Width)/4)^2</th>
                                                    <th>Ecological Volume</th>
                                                    <th>ln(Ecological Volume)</th>
                                                    <th>Volume Cylinder</th>
                                                    <th>Tip Number</th>
                                                    <th>Old Tag</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${table_body_contents}
                                            </tbody>
                                        </table>`;

                $("#out_table").append(table_template);
        }


    </script>

</body>
</html>
